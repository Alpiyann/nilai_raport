<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portal Akademik - Sistem Manajemen Nilai dan Rekomendasi PTN">
    <title>Portal Akademik - Login</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .login-card {
            width: 100%;
            max-width: 440px;
            padding: var(--space-10);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-6);
            background: var(--gradient-primary);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: var(--shadow-glow);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: var(--shadow-glow);
            }

            50% {
                box-shadow: 0 0 50px rgba(124, 58, 237, 0.5);
            }
        }

        .login-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .login-tabs {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }

        .login-tab {
            flex: 1;
            padding: var(--space-3);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .login-tab.active {
            background: var(--gradient-primary);
            color: var(--text-primary);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin: var(--space-6) 0;
            color: var(--text-muted);
            font-size: var(--font-size-sm);
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }

        .login-demo {
            text-align: center;
            padding: var(--space-4);
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: var(--radius-lg);
        }

        .login-demo-title {
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-bottom: var(--space-2);
            color: var(--primary-400);
        }

        .login-demo-credentials {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .login-demo-credentials code {
            background: rgba(255, 255, 255, 0.1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-family: monospace;
        }

        .password-toggle {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: var(--text-primary);
        }

        .form-input-password {
            position: relative;
        }

        .form-input-password .form-input {
            padding-right: calc(var(--space-4) + 24px + var(--space-2));
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-600);
            cursor: pointer;
        }

        .remember-me label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            cursor: pointer;
        }

        .forgot-password-link {
            font-size: var(--font-size-sm);
            color: var(--primary-400);
            text-decoration: none;
            margin-left: auto;
            cursor: pointer;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            font-size: var(--font-size-sm);
            display: none;
        }

        .alert.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .alert-error {
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: var(--accent-rose);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--accent-emerald);
        }
    </style>
</head>

<body>
    <div class="animated-bg"></div>

    <div class="login-container">
        <div class="login-card glass-card-static">
            <div class="login-header">
                <div class="login-logo">ðŸŽ“</div>
                <h1 class="login-title">Cek Rata Rata Nilaimu Disini</h1>
                <p class="login-subtitle">Cari tahu peluangmu masuk PTN impian</p>
            </div>

            <div class="login-tabs">
                <button class="login-tab active" data-tab="login">Masuk</button>
                <button class="login-tab" data-tab="register">Daftar</button>
            </div>

            <div id="alert" class="alert"></div>

            <!-- Login Form -->
            <form id="loginForm" class="login-form active">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email</label>
                    <div class="form-input-icon">
                        <i class="fa-solid fa-envelope icon"></i>
                        <input type="email" id="loginEmail" class="form-input" placeholder="nama@email.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <div class="form-input-password">
                        <input type="password" id="loginPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="remember-me">
                    <input type="checkbox" id="remember">
                    <label for="remember">Ingat saya</label>
                    <a class="forgot-password-link" onclick="showForgotForm()">Lupa Password?</a>
                </div>

                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    Masuk
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label class="form-label" for="registerName">Nama Lengkap</label>
                    <div class="form-input-icon">
                        <i class="fa-solid fa-user icon"></i>
                        <input type="text" id="registerName" class="form-input" placeholder="Nama Lengkap" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerEmail">Email</label>
                    <div class="form-input-icon">
                        <i class="fa-solid fa-envelope icon"></i>
                        <input type="email" id="registerEmail" class="form-input" placeholder="nama@email.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerPassword">Password</label>
                    <div class="form-input-password">
                        <input type="password" id="registerPassword" class="form-input" placeholder="Minimal 6 karakter"
                            required minlength="6">
                        <button type="button" class="password-toggle"
                            onclick="togglePassword('registerPassword', this)">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Konfirmasi Password</label>
                    <div class="form-input-password">
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Ulangi password"
                            required>
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fa-solid fa-user-plus"></i>
                    Daftar Sekarang
                </button>
            </form>

            <!-- Verification Form -->
            <form id="verifyForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">Kode Verifikasi (OTP)</label>
                    <div class="form-input-group">
                        <span class="form-input-icon">
                            <i class="fa-solid fa-key"></i>
                        </span>
                        <input type="text" id="verifyOtp" class="form-input" placeholder="Masukkan 6 digit kode OTP"
                            required maxlength="6" style="letter-spacing: 5px; text-align: center; font-size: 1.2rem;">
                    </div>
                    <p class="login-subtitle" style="margin-top: 10px; text-align: center;">Cek email Anda untuk kode
                        verifikasi</p>
                </div>
                <input type="hidden" id="verifyEmail">

                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    Verifikasi Akun
                </button>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">Email Terdaftar</label>
                    <div class="form-input-group">
                        <span class="form-input-icon">
                            <i class="fa-solid fa-envelope"></i>
                        </span>
                        <input type="email" id="forgotEmail" class="form-input" placeholder="nama@email.com" required>
                    </div>
                    <p class="login-subtitle" style="margin-top: 10px;">Kode reset akan dikirim ke email ini.</p>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;"
                        onclick="showLoginForm()">Batal</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Kirim Kode</button>
                </div>
            </form>

            <!-- Reset Password Form -->
            <form id="resetForm" class="login-form">
                <input type="hidden" id="resetEmail">
                <div class="form-group">
                    <label class="form-label">Kode OTP</label>
                    <div class="form-input-group">
                        <span class="form-input-icon"><i class="fa-solid fa-key"></i></span>
                        <input type="text" id="resetOtp" class="form-input" placeholder="6 Digit OTP" required
                            maxlength="6" style="letter-spacing: 5px; text-align: center;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Password Baru</label>
                    <div class="form-input-group form-input-password">
                        <span class="form-input-icon"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="resetNewPassword" class="form-input" placeholder="Password baru"
                            required minlength="6">
                        <button type="button" class="password-toggle"
                            onclick="togglePassword('resetNewPassword', this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Reset Password</button>
            </form>
        </div>

        <script>
            // Tab switching
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));

                    tab.classList.add('active');
                    const formId = tab.dataset.tab === 'login' ? 'loginForm' : 'registerForm';
                    document.getElementById(formId).classList.add('active');

                    hideAlert();
                });
            });

            // Toggle password visibility
            function togglePassword(inputId, button) {
                const input = document.getElementById(inputId);
                const type = input.type === 'password' ? 'text' : 'password';
                input.type = type;

                // Update icon
                const icon = button.querySelector('svg');
                if (type === 'text') {
                    icon.innerHTML = `
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path>
                    <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path>
                    <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path>
                    <line x1="2" y1="2" x2="22" y2="22"></line>
                `;
                } else {
                    icon.innerHTML = `
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                `;
                }
            }

            // Show alert
            function showAlert(message, type = 'error') {
                const alert = document.getElementById('alert');
                alert.textContent = message;
                alert.className = `alert alert-${type} show`;
            }

            // Hide alert
            function hideAlert() {
                const alert = document.getElementById('alert');
                alert.classList.remove('show');
            }

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> Memproses...';

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert('Login berhasil! Mengalihkan...', 'success');
                        localStorage.setItem('user', JSON.stringify(data.user));
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1000);
                    } else {
                        if (data.requireVerification) {
                            // Handle unverified user trying to login
                            showAlert('Akun belum diverifikasi. Cek email untuk OTP.', 'error');
                            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                            document.getElementById('verifyForm').classList.add('active');
                            document.getElementById('verifyEmail').value = data.email;

                            // Hide tabs
                            document.querySelector('.login-tabs').style.display = 'none';
                            document.querySelector('.login-title').textContent = 'Verifikasi Email';
                            document.querySelector('.login-subtitle').textContent = 'Masukkan kode yang dikirim ke ' + data.email;
                        } else {
                            showAlert(data.message || 'Login gagal');
                        }
                    }
                } catch (error) {
                    showAlert('Terjadi kesalahan. Silakan coba lagi.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Masuk
                `;
                }
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const nama = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (password !== confirmPassword) {
                    showAlert('Password tidak cocok');
                    return;
                }

                if (password.length < 6) {
                    showAlert('Password minimal 6 karakter');
                    return;
                }

                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> Memproses...';

                try {
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nama, email, password })
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.requireVerification) {
                            // Switch to verification form
                            showAlert('Registrasi berhasil! Silakan cek email untuk kode OTP.', 'success');
                            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                            document.getElementById('verifyForm').classList.add('active');
                            document.getElementById('verifyEmail').value = email;

                            // Hide tabs
                            document.querySelector('.login-tabs').style.display = 'none';
                            document.querySelector('.login-title').textContent = 'Verifikasi Email';
                            document.querySelector('.login-subtitle').textContent = 'Masukkan kode yang dikirim ke ' + email;
                        } else {
                            showAlert('Registrasi berhasil! Silakan login.', 'success');
                            setTimeout(() => {
                                document.querySelector('[data-tab="login"]').click();
                                document.getElementById('loginEmail').value = email;
                            }, 1500);
                        }
                    } else {
                        showAlert(data.message || 'Registrasi gagal');
                    }
                } catch (error) {
                    showAlert('Terjadi kesalahan. Silakan coba lagi.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <line x1="19" y1="8" x2="19" y2="14"></line>
                        <line x1="22" y1="11" x2="16" y2="11"></line>
                    </svg>
                    Daftar Sekarang
                `;
                }
            });

            // Verify form
            document.getElementById('verifyForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = document.getElementById('verifyEmail').value;
                const otp = document.getElementById('verifyOtp').value;

                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> Memproses...';

                try {
                    const response = await fetch('/api/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, otp })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert('Verifikasi berhasil! Silakan login.', 'success');
                        setTimeout(() => {
                            window.location.reload(); // Reload to reset state to login
                        }, 1500);
                    } else {
                        showAlert(data.message || 'Verifikasi gagal');
                    }
                } catch (error) {
                    showAlert('Terjadi kesalahan. Silakan coba lagi.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Verifikasi Akun';
                }
            });

            // Check if already logged in
            async function checkAuth() {
                try {
                    const response = await fetch('/api/auth/status');
                    const data = await response.json();
                    if (data.isAuthenticated) {
                        window.location.href = '/dashboard';
                    }
                } catch (error) {
                    console.log('Auth check failed');
                }
            }

            checkAuth();

            // Forgot & Reset Logic
            function showForgotForm() {
                hideAlert();
                document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                document.getElementById('forgotForm').classList.add('active');
                document.querySelector('.login-tabs').style.display = 'none';
                document.querySelector('.login-title').textContent = 'Lupa Password';
                document.querySelector('.login-subtitle').textContent = 'Reset password Anda dengan aman';
            }

            function showLoginForm() {
                hideAlert();
                document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                document.getElementById('loginForm').classList.add('active');
                document.querySelector('.login-tabs').style.display = 'flex';
                document.querySelector('.login-title').textContent = 'Cek Rata Rata Nilaimu Disini';
                document.querySelector('.login-subtitle').textContent = 'Cari tahu peluangmu masuk PTN impian ðŸš€';
            }

            document.getElementById('forgotForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value;
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;

                try {
                    const res = await fetch('/api/auth/forgot-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const data = await res.json();

                    if (data.success) {
                        showAlert('Kode reset telah dikirim ke email Anda.', 'success');
                        document.getElementById('resetEmail').value = email;

                        // Switch to reset form
                        document.getElementById('forgotForm').classList.remove('active');
                        document.getElementById('resetForm').classList.add('active');
                        document.querySelector('.login-title').textContent = 'Reset Password';
                        document.querySelector('.login-subtitle').textContent = 'Masukkan kode OTP dan password baru';
                    } else {
                        showAlert(data.message);
                    }
                } catch (err) {
                    showAlert('Gagal mengirim permintaan.');
                } finally {
                    btn.disabled = false;
                }
            });

            document.getElementById('resetForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value;
                const otp = document.getElementById('resetOtp').value;
                const newPassword = document.getElementById('resetNewPassword').value;

                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;

                try {
                    const res = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, otp, newPassword })
                    });
                    const data = await res.json();

                    if (data.success) {
                        showAlert('Password berhasil diubah! Silakan login.', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showAlert(data.message);
                    }
                } catch (err) {
                    showAlert('Gagal mereset password.');
                } finally {
                    btn.disabled = false;
                }
            });
        </script>
</body>

</html>